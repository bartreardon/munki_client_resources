// initial version
// place this in footer_template.html

// getPriceList, buyApp and checkPurchasedStatus are obviously site dependant and will need
// some form of backend to support. Could be simple db or other that returns json.

<style>
div.msc-button-inner.buy:not(.large) {
    background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#7abcff), color-stop(100%,#4096ee));
}

div.msc-button-inner.buy:hover {
    background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#42A0FF), color-stop(100%,#107EED));
}

.overlay {
    width:100%;
    height:100%;
    position:fixed;
    top:0;
    left:0;
    display:none;
}

.overlay.pageDimmer {
    background:#000;
    opacity:0.5;
    z-index:99;
}

.overlay.pageDisplay {
    top: 260px;
    -webkit-transform: translateX(20%);
    z-index:999;
    width:70%;
    height:50%;
    -webkit-border-radius: 5px;
    background:#ffffff;
}
</style>

<div class="overlay pageDimmer" id="pageDimmer"></div>
<div class="overlay pageDisplay" id="pageDisplay" onclick="displayPage(false);"></div>

<script type="text/javascript">

priceListInit();
setInterval(function () {priceListInit()}, 120000); // refresh the buttons every 2 minutes - if left alone, MSC can revert these to normal "install"

function displayPage(bool, url)
{
    if (typeof bool=='undefined') bool=true;
    document.getElementById('pageDimmer').style.display=(bool?'block':'none');
    document.getElementById('pageDisplay').style.display=(bool?'block':'none');
    document.getElementById('pageDisplay').innerHTML = '<object type="text/html" data="'+url+'" type="text/html"><embed src="'+url+'" type="text/html" /></object>';
    //window.open(url,'_self',false);
    //document.location = url;
} 

function priceListInit() {
	var url = "http://localhost/munki_repo/pricelist.json"; //custom - call some generator or static file, return json
	getPriceList(url);
}

function getPriceList(url) {
	var xmlhttp = new XMLHttpRequest();

	xmlhttp.onreadystatechange = function() {
		if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
			//move this call outside the function?
			processPrices(JSON.parse(xmlhttp.responseText));
		}
	}
	xmlhttp.open("GET", url, true);
	xmlhttp.send();
}

function processPrices(pricesArray) {
	var installButtons = document.getElementsByClassName('msc-button-inner not-installed');
	for (var i = 0; i < installButtons.length; i++) {
		var appName = installButtons[i].id.replace('_action_button_text','');
		for(var p = 0; p < pricesArray.length; p++) {
			if (appName == pricesArray[p].appName && checkPurchasedStatus(appName) != true) {
				var appButton = document.getElementById(installButtons[i].id);
				if (appButton.innerHTML.indexOf("Install") > -1 && appButton.innerHTML.indexOf("Installed") <= 0) {
					appButton.innerHTML = 'Purchase : $'+pricesArray[p].price;
					appButton.parentNode.onclick = function(){ buyApp(this.children[0].id.replace('_action_button_text','')); };
					appButton.className = appButton.className + ' buy';
				}
			}
		}
	}
}

function buyApp(appName) {
	// custom app processing code goes here
	// send appname to a url or whathaveyou for purchase.
	// determine current username, send that as well etc. 
	alert('Thank you for your purchase of ' + appName); //alerts don't display in MSC - testing only
	displayPage(true, 'http://your.org/purchasing/backend/or/whatever.asp?app='+appName); //display in MSC app. move to overlay or something perhaps or leave as is.
	//location.reload();
}

function checkPurchasedStatus(appName) {
	// verify if the application has been purchased
	// this portion will need to be deployment specific
	if (appName == 'foo') {
		return true;
	} else {
		return false;
	}
}
</script>
